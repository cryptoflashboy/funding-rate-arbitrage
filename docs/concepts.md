## Video Walkthrough
A high level walkthrough can be found via following this link:
[Watch here](https://www.youtube.com/watch?v=XvzK4EbU8Bk)

## Profitability Estimations
As of version 0.2.1, the impact of a potential trade on funding velocity is now taken into consideration when assessing the profitability of a position - maker/taker fees are also taken into account, and 8 new markets have been added to the searcher algorithm (by default, all will be selected). More markets will be added in future releases as they amass sufficient liquidity.

To estimate the profit for a trade we start with the Synthetix half - the trade details are generated by the MatchingEngine module and passed to CheckProfitability.py, where the user's `BASE_TRADE_SIZE_USD` is multiplied by their `TRADE_LEVERAGE` to find the total dollar value of the position. The market price of the asset is then called, and the dollar value converted into the amount of the asset in question which is halved, giving us the trade size per trade leg and finally we adjust for the side (long or short) of each trade and factor in the expected price impact. 
Now that we have the size of the position we are going to place on Synthetix, the next step is to calculate the effect that our trade will have on the funding velocity of the respective market. To do this, we use the `skew` value in our `opportunity` object along with the our trade size, and pass these as arguments to a helper function that will return the funding velocity after our trade is placed:
```python
@staticmethod
    def calculate_new_funding_velocity(symbol: str, current_skew: float, trade_size: float) -> float:
        try:
            market_data = MarketDirectory.get_market_params(symbol)
            c = market_data['max_funding_velocity'] / market_data['skew_scale']
            new_skew = current_skew + trade_size
            new_funding_velocity = c * new_skew
            return new_funding_velocity
        except Exception as e:
            raise ValueError(f"GlobalUtils - Failed to calculate new funding velocity for {symbol}: {e}")
```
Funding velocity is defined as the product of the formula $dr/dt=c*skew$, where $dr/dt$ is the velocity, $c$ is the constant factor $(maxFundingVelocity / skewScale)$, and $skew$ is the measure of the imbalance between long and short open interest in the given market, measured in units of said asset. 

> (If this is a bit abstract, there's a good blog post that you can find [here](https://blog.synthetix.io/synthetix-perps-dynamic-funding-rates/) with some more intuitive explanations)

So to calculate the new funding velocity we solve for the above function by grabbing the market details from the `MarketDirectory` class, which will be of type:
```python
'ETH': {
        'market_id': 100,
        'symbol': 'ETH',
        'max_funding_velocity': 9,
        'skew_scale': 350000,
        'maker_fee': 0.000001,
        'taker_fee': 0.0005
    }
```
from which we calculate our constant factor and our new funding velocity.

Now that we have our funding velocity, we have to do some further calculations to give us an estimate of how long it will take before the funding rate turns against our trade. Fundamentally, the velocity figure shows us where the funding rate will be in 24 hours' time assuming no other trades are placed within that period. To visualise this, we can illustrate the funding rate over time on a chart like so:
![Funding Velocity](Assets/velocity1.png)
Where the green shaded area is our profit, and the funding velocity is represented by the gradient of the funding rate value over time. As we can see, once our trade is placed a new funding rate velocity is calculated and the gradient of the line changes; in this example there is already a negative funding velocity (funding rate is headed downwards), and our short trade increases the rate at which this change is occuring. You can visualise the profit as the sum of the green shaded area.
